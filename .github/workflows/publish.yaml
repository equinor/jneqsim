name: "Publish"
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version of Neqsim to publish"
        required: true
        type: string
      pypi_version:
        description: "Version to publish jNeqsim to PyPI as"
        required: false
        type: string
  workflow_call:
    inputs:
      version:
        description: "Version to publish"
        required: true
        type: string
    secrets:
      SLACK_WEBHOOK_URL:
        required: false

jobs:
  publish:
    name: Publish package to PyPI
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@master

      - name: Install Poetry
        run: pipx install poetry

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "poetry"

      - name: Install build tools
        run: pip install build hatch

      - name: Install deps
        run: poetry install --no-interaction

      - name: Check for new NeqSim release and JAR asset
        id: check-release
        run: |
          set -e

          # Fetch latest release tag from GitHub
          LATEST_TAG=$(curl -s https://api.github.com/repos/equinor/neqsim/releases/latest | jq -r '.tag_name')
          LATEST_VERSION="${LATEST_TAG#v}"

          # Check if the JAR asset exists (Java 11 example)
          JAR_URL="https://github.com/equinor/neqsim/releases/download/${LATEST_TAG}/neqsim-${LATEST_VERSION}.jar"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$JAR_URL")

          # Fetch current jneqsimsmall version from TestPyPI
          CURRENT_JNEQSIM=$(curl -s https://test.pypi.org/pypi/jneqsimsmall/json | jq -r '.info.version')

          echo "Latest tag: $LATEST_TAG"
          echo "Latest version: $LATEST_VERSION"
          echo "Current jneqsimsmall: $CURRENT_JNEQSIM"
          echo "JAR URL: $JAR_URL (HTTP $HTTP_STATUS)"

          if [[ "$HTTP_STATUS" == "200" && "$LATEST_VERSION" != "$CURRENT_JNEQSIM" ]]; then
            echo "new_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "fallback_version=$CURRENT_JNEQSIM" >> $GITHUB_OUTPUT
            echo "New NeqSim JAR is available and not yet published to TestPyPI."
          else
            echo "new_version=" >> $GITHUB_OUTPUT
            echo "fallback_version=" >> $GITHUB_OUTPUT
            echo "No new NeqSim JAR to publish."
          fi

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
  

      - name: Update dependencies.yaml version
        if: ${{ steps.check-release.outputs.new_version != '' }}
        uses: mikefarah/yq@v4.49.2
        with:
          cmd: yq -i '.neqsim.version = "${{ steps.check-release.outputs.new_version }}"' jneqsim/dependencies.yaml

      - name: Update dependencies.yaml fallback_version
        if: ${{ steps.check-release.outputs.new_version != '' }}
        uses: mikefarah/yq@v4.49.2
        with:
          cmd: yq -i '.neqsim.fallback_version = "${{ steps.check-release.outputs.fallback_version }}"' jneqsim/dependencies.yaml



      - name: Generate stubs
        run: poetry run python ./generate_stubs.py

      - name: Fixup module naming
        run: find jneqsim/neqsim -type f -name "*.pyi" -print0 | xargs -0  sed -i '' -e 's/neqsim./jneqsim.neqsim./g' || true


      - name: Bump version
        run: |
          VERSION="${{ inputs.pypi_version || inputs.version }}"
          echo "Setting jNeqsim version to '$VERSION'"
          poetry version "$VERSION"

      - name: Build
        # delete .gitignore. If not the ignored files will not be added to the package
        run: rm .gitignore && poetry build

      - name: Install package and test it
        run: |
          cd tests
          python -m venv .venv
          source .venv/bin/activate
          pip install ../dist/jneqsimsmall-*.tar.gz pytest
          pytest

      # - name: Publish package distributions to PyPI
      #   uses: pypa/gh-action-pypi-publish@release/v1
      #   with:
      #     attestations: false
      
      - name: Publish package to TestPyPI
        run: hatch publish -r test
        env:
          HATCH_INDEX_USER: __token__
          HATCH_INDEX_AUTH: ${{ secrets.TEST_PYPI_TOKEN_MAOHE }}

      # - name: Notify publish success to Slack
      #   if: ${{ success() }}
      #   uses: slackapi/slack-github-action@v2.1.1
      #   with:
      #     webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     webhook-type: incoming-webhook
      #     payload: |
      #       {
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "‚úÖ Successfully published jNeqSim version ${{ inputs.version }} to PyPI! üéâ\nPackage is now available: https://pypi.org/project/jneqsim/${{ inputs.version }}/"
      #             }
      #           }
      #         ]
      #       }

      # - name: Notify publish failure to Slack
      #   if: ${{ failure() || cancelled() }}
      #   uses: slackapi/slack-github-action@v2.1.1
      #   with:
      #     webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     webhook-type: incoming-webhook
      #     payload: |
      #       {
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "‚ùå Failed to publish jNeqSim version ${{ inputs.version }} to PyPI. Check the workflow for details: \n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      #             }
      #           }
      #         ]
      #       }
