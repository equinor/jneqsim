name: "Publish"
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version of Neqsim to publish"
        required: true
        type: string
      pypi_version:
        description: "Version to publish jNeqsim to PyPI as"
        required: false
        type: string
  workflow_call:
    inputs:
      version:
        description: "Version to publish"
        required: true
        type: string
    secrets:
      SLACK_WEBHOOK_URL:
        required: false

jobs:
  publish:
    name: Publish package to PyPI
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@master

      - name: Install Poetry
        run: pipx install poetry

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "poetry"

      - name: Install build tools
        run: pip install build hatch

      - name: Install deps
        run: poetry install --no-interaction

      - name: Update NeqSim dependency version
        run: |
          NEQSIM_VERSION="${{ inputs.version }}"
          echo "Updating NeqSim dependency to version '$NEQSIM_VERSION'"
          
          # Get the current version to use as fallback
          CURRENT_VERSION=$(grep -o 'version: "[^"]*"' jneqsim/dependencies.yaml | sed 's/version: "\(.*\)"/\1/')
          echo "Current version (will become fallback): '$CURRENT_VERSION'"
          echo "New version: '$NEQSIM_VERSION'"
          
          # Update the main version to the new version
          sed -i "s/version: \"[^\"]*\"/version: \"$NEQSIM_VERSION\"/" jneqsim/dependencies.yaml
          
          # Set fallback version to the previous version (current before update)
          sed -i "s/fallback_version: \"[^\"]*\"/fallback_version: \"$CURRENT_VERSION\"/" jneqsim/dependencies.yaml
          
          echo "Updated dependencies.yaml:"
          grep -A 10 -B 5 "version:" jneqsim/dependencies.yaml
          
      - name: Generate stubs
        run: poetry run python ./generate_stubs.py

      - name: Fixup module naming
        run: find jneqsim/neqsim -type f -name "*.pyi" -print0 | xargs -0  sed -i '' -e 's/neqsim./jneqsim.neqsim./g' || true


      - name: Bump version
        run: |
          VERSION="${{ inputs.pypi_version || inputs.version }}"
          echo "Setting jNeqsim version to '$VERSION'"
          poetry version "$VERSION"

      - name: Build
        # delete .gitignore. If not the ignored files will not be added to the package
        run: rm .gitignore && poetry build

      - name: Install package and test it
        run: |
          cd tests
          python -m venv .venv
          source .venv/bin/activate
          pip install ../dist/jneqsimsmall-*.tar.gz pytest
          pytest

      # - name: Publish package distributions to PyPI
      #   uses: pypa/gh-action-pypi-publish@release/v1
      #   with:
      #     attestations: false
      
      - name: Publish package to TestPyPI
        run: hatch publish -r test
        env:
          HATCH_INDEX_USER: __token__
          HATCH_INDEX_AUTH: ${{ secrets.TEST_PYPI_TOKEN_MAOHE }}

      # - name: Notify publish success to Slack
      #   if: ${{ success() }}
      #   uses: slackapi/slack-github-action@v2.1.1
      #   with:
      #     webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     webhook-type: incoming-webhook
      #     payload: |
      #       {
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "‚úÖ Successfully published jNeqSim version ${{ inputs.version }} to PyPI! üéâ\nPackage is now available: https://pypi.org/project/jneqsim/${{ inputs.version }}/"
      #             }
      #           }
      #         ]
      #       }

      # - name: Notify publish failure to Slack
      #   if: ${{ failure() || cancelled() }}
      #   uses: slackapi/slack-github-action@v2.1.1
      #   with:
      #     webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     webhook-type: incoming-webhook
      #     payload: |
      #       {
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "‚ùå Failed to publish jNeqSim version ${{ inputs.version }} to PyPI. Check the workflow for details: \n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      #             }
      #           }
      #         ]
      #       }
